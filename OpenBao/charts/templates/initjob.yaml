apiVersion: batch/v1
kind: Job
metadata:
  name: init-bao
spec:
  template:
    spec:
      serviceAccountName: openbao-{{ .Values.cluster.namespace }}-svc-account
      initContainers:
      - name: 2-unseal
        image: "quay.io/openbao/openbao:2.4.0"
        command: [sh, -c]
        args:
          - |
            echo "Comprobando si Bao está sealed..."
            SEALED=$(bao status | jq -r .sealed || echo "true")

            if [ "$SEALED" = "false" ]; then
              echo "Bao ya está unsealed. Saliendo."
              exit 0
            fi

            echo "Bao está sealed → procediendo a unseal con las 3 keys"
            bao operator unseal "$unseal_key1"
            bao operator unseal "$unseal_key2"
            bao operator unseal "$unseal_key3"

            echo "Unseal completado."
        env:
          - name: VAULT_ADDR
            value: https://secrets.{{ .Values.namespaceTag }}.{{ .Values.domainSuffix }}
        envFrom:
        - secretRef:
            name: secrets-unseal-keys
      - name: 3-kv-secretengine
        image: "quay.io/openbao/openbao:2.4.0"
        command: [sh, -c]
        args:
          - |
            bao secrets enable -path={{ .Values.secrets.secretEngine }} -version=2 kv || true
            bao secrets enable -path=secret -version=2 kv || true
        env:
          - name: VAULT_TOKEN
            valueFrom:
              secretKeyRef:
                name: secrets-root-token
                key: token
          - name: VAULT_ADDR
            value: https://secrets.{{ .Values.namespaceTag }}.{{ .Values.domainSuffix }}
      - name: 4-transit-secretengine
        image: "quay.io/openbao/openbao:2.4.0"
        command: [sh, -c]
        args:
          - |
            bao secrets enable -path=transit/simpl transit || true
            bao write transit/simpl/keys/gaia-x-key1 type=ed25519 || true
        env:
          - name: VAULT_TOKEN
            valueFrom:
              secretKeyRef:
                name: secrets-root-token
                key: token
          - name: VAULT_ADDR
            value: https://secrets.{{ .Values.namespaceTag }}.{{ .Values.domainSuffix }}
      - name: 5-kubernetes-policy-role
        image: "quay.io/openbao/openbao:2.4.0"
        command: [sh, -c]
        args:
          - |
            bao policy write {{ .Values.secrets.secretEngine }}-policy - <<EOF
            path "{{ .Values.secrets.secretEngine }}/*" {
              capabilities = ["create", "read", "update", "delete", "list"]
            }
            EOF

            bao policy write eso-read-secrets - <<EOF
            path "auth/kubernetes/login" {
              capabilities = ["update"]
            }
            path "secret/data/cloud-accounts/*" {
              capabilities = ["create", "read", "update", "list"]
            }
            path "secret/data/cloud-accounts/*/*" {
              capabilities = ["create", "read", "update", "list"]
            }
            EOF

            {{ $authorities := default (list) .Values.agentList.authorities }}
            {{ $providers := default (list) .Values.agentList.providers }}
            {{ $consumers := default (list) .Values.agentList.consumers }}
            {{ $namespace := default "default-namespace" .Values.cluster.namespace }}

            bao auth enable kubernetes || true
            bao write auth/kubernetes/config kubernetes_host=https://10.3.0.1
            bao write auth/kubernetes/role/{{ .Values.secrets.secretEngine }}-role \
            bound_service_account_names="*-sa","*-service-account","*-service","*-consumption-be","*-svc-account",'*{{ regexReplaceAll "^.*(.)$" .Values.cluster.namespace "${1}" }}',"default","keycloak","edc-connector-adapter" \
            bound_service_account_namespaces={{ range $index, $item := (concat $authorities $providers $consumers (list $namespace) (list (printf "%s-vswh" $namespace))) }}{{if $index}},{{end}}"{{ $item }}"{{ end }} \
            policies="{{ .Values.secrets.secretEngine }}-policy" || true

            bao write auth/kubernetes/role/eso-role \
            bound_service_account_names="eso" \
            bound_service_account_namespaces={{ range $index, $item := .Values.agentList.providers }}{{if $index}},{{end}}"{{ $item }}"{{ end }} \
            policies="eso-read-secrets" \
            ttl="24h" || true
        env:
          - name: VAULT_TOKEN
            valueFrom:
              secretKeyRef:
                name: secrets-root-token
                key: token
          - name: VAULT_ADDR
            value: https://secrets.{{ .Values.namespaceTag }}.{{ .Values.domainSuffix }}
      - name: 6-common-secrets
        image: "quay.io/openbao/openbao:2.4.0"
        command: [sh, -c]
        args:
          - |
            bao kv put -mount={{ .Values.secrets.secretEngine }} {{ .Values.cluster.namespace }}-redpanda-credentials admin=$redpanda_pass
            bao kv put -mount={{ .Values.secrets.secretEngine }} {{ .Values.cluster.namespace }}-pgadmin-credentials password=$pgadmin_pass postgres=$postgres_pass
            if ! bao kv get -mount={{ .Values.secrets.secretEngine }} {{ .Values.cluster.namespace }}-notifications > /dev/null 2>&1; then
              bao kv put -mount={{ .Values.secrets.secretEngine }} {{ .Values.cluster.namespace }}-notifications \
                API_KEY=apikey \
                KAFKA_CLIENT_PASSWORDS=$notification \
                SMTP_PASSWORD=smtppass
            fi
            if ! bao kv get -mount={{ .Values.secrets.secretEngine }} {{ .Values.cluster.namespace }}-icms > /dev/null 2>&1; then
              bao kv put -mount={{ .Values.secrets.secretEngine }} {{ .Values.cluster.namespace }}-icms \
                API_KEY=apikey \
                APPLICATION_KEY=applicationkey \
                APPLICATION_SECRET=appsecret \
                CONSUMER_KEY=conskey \
                KAFKA_CLIENT_PASSWORDS=$icms
            fi
            bao kv put -mount={{ .Values.secrets.secretEngine }} {{ .Values.cluster.namespace }}-vault token=$VAULT_TOKEN
            if ! bao kv get -mount={{ .Values.secrets.secretEngine }} {{ .Values.cluster.namespace }}-kafka-credentials > /dev/null 2>&1; then
              bao kv put -mount={{ .Values.secrets.secretEngine }} {{ .Values.cluster.namespace }}-kafka-credentials \
                {{- range .Values.agentList.authorities }}
                {{ . }}_authprovider=${{ . }}_authprovider \
                {{ . }}_usersroles=${{ . }}_usersroles \
                {{ . }}_onboarding=${{ . }}_onboarding \
                {{ . }}_tier2gw=${{ . }}_tier2gw \
                {{- end }}
                {{- range .Values.agentList.providers }}
                {{ . }}_authprovider=${{ . }}_authprovider \
                {{ . }}_usersroles=${{ . }}_usersroles \
                {{ . }}_contract=${{ . }}_contract \
                {{ . }}_infrabe=${{ . }}_infrabe \
                {{ . }}_tier2gw=${{ . }}_tier2gw \
                {{- end }}
                {{- range .Values.agentList.consumers }}
                {{ . }}_authprovider=${{ . }}_authprovider \
                {{ . }}_usersroles=${{ . }}_usersroles \
                {{ . }}_contract=${{ . }}_contract \
                {{ . }}_contract_consumption=${{ . }}_contract_consumption \
                {{ . }}_tier2gw=${{ . }}_tier2gw \
                {{ . }}_edcconn=${{ . }}_edcconn \
                {{- end }}
                redpanda=$redpanda \
                notification=$notification \
                icms=$icms
            fi
            {{- if .Values.mailpit.enabled }}
            bao kv put -mount={{ .Values.secrets.secretEngine }} {{ .Values.cluster.namespace }}-mailpit admin=$mailpit_pass
            {{- end }}
        envFrom:
          - secretRef:
              name: kafka-users-secret
        env:
          - name: VAULT_TOKEN
            valueFrom:
              secretKeyRef:
                name: secrets-root-token
                key: token
          - name: VAULT_ADDR
            value: https://secrets.{{ .Values.namespaceTag }}.{{ .Values.domainSuffix }}
          - name: "redpanda_pass"
            valueFrom:
              secretKeyRef:
                name: "redpanda-secret"
                key: password
          - name: "pgadmin_pass"
            valueFrom:
              secretKeyRef:
                name: "pg-admin-secret"
                key: password
          - name: "postgres_pass"
            valueFrom:
              secretKeyRef:
                name: "postgres.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "mailpit_pass"
            valueFrom:
              secretKeyRef:
                name: "mailpit-secrets"
                key: ui
      {{- range .Values.agentList.authorities }}
      - name: 6-authority-secrets
        image: "quay.io/openbao/openbao:2.4.0"
        command: [sh, -c]
        args:
          - |
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-xsfc-service \
              DATASTORE_FILE_PATH="/var/lib/fc-service/filestore" \
              FEDERATED_CATALOGUE_VERIFICATION_SIGNATURES="true" \
              GRAPHSTORE_PASSWORD="neo12345" \
              GRAPHSTORE_QUERY_TIMEOUT_IN_SECONDS="5" \
              GRAPHSTORE_URI="bolt://xsfc-neo4j:7687" \
              SPRING_DATASOURCE_PASSWORD=${{ . }}_fcservice \
              SPRING_DATASOURCE_URL="jdbc:postgresql://pg-cluster.{{ $.Values.cluster.namespace }}.svc.cluster.local:5432/{{ . }}_fcservice" \
              SPRING_DATASOURCE_USERNAME="{{ . }}_fcservice" \
              OTEL_EXPORTER_OTLP_ENDPOINT="http://collector.{{ $.Values.namespaceTag }}.{{ $.Values.domainSuffix }}" \
              OTEL_RESOURCE_ATTRIBUTES_DEPLOYMENT_ENVIRONMENT="{{ $.Values.domainSuffix }}" \
              OTEL_SDK_DISABLED="false"
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-adapter-simpl-backend \
              FEDERATED_CATALOOGUE_CLIENT_URL="http://xsfc-service:8081" \
              OTEL_EXPORTER_OTLP_ENDPOINT="http://collector.{{ $.Values.namespaceTag }}.{{ $.Values.domainSuffix }}" \
              OTEL_RESOURCE_ATTRIBUTES_DEPLOYMENT_ENVIRONMENT="{{ $.Values.domainSuffix }}" \
              OTEL_SDK_DISABLED="false"
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-redis \
              rediscommander=$commander \
              redis=$redis
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-postgres-passwords \
              {{ . }}-authenticationprovider=${{ . }}_authenticationprovider \
              {{ . }}-ejbca=${{ . }}_ejbca \
              {{ . }}-identityprovider=${{ . }}_identityprovider \
              {{ . }}-keycloak=${{ . }}_keycloak \
              {{ . }}-onboarding=${{ . }}_onboarding \
              {{ . }}-securityattributesprovider=${{ . }}_securityattributesprovider \
              {{ . }}-usersroles=${{ . }}_usersroles
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-keycloak admin=${{ . }}_kcadmin
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-ejbca keystorepass=${{ . }}_ejbcakspass
            if ! bao kv get -mount={{ $.Values.secrets.secretEngine }} {{ . }}-simpl-schema-manager > /dev/null 2>&1; then
              bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-simpl-schema-manager \
                ADMIN_PASSWORD=${{ . }}_schemamgr \
                FUSEKI_BASE_URL="http://fuseki-service.{{ . }}.svc.cluster.local:3030"
            fi    
        envFrom:
          - secretRef:
              name: redis-secrets
        env:
          - name: VAULT_TOKEN
            valueFrom:
              secretKeyRef:
                name: secrets-root-token
                key: token
          - name: VAULT_ADDR
            value: https://secrets.{{ $.Values.namespaceTag }}.{{ $.Values.domainSuffix }}
          - name: "{{ . }}_kcadmin"
            valueFrom:
              secretKeyRef:
                name: "keycloak-secrets"
                key: {{ . }}
          - name: "{{ . }}_ejbcakspass"
            valueFrom:
              secretKeyRef:
                name: "ejbca-secret"
                key: "keystorepass"
          - name: "{{ . }}_schemamgr"
            valueFrom:
              secretKeyRef:
                name: "schema-manager-secret"
                key: "admin"
          - name: "{{ . }}_fcservice"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-fcservice.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_authenticationprovider"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-authenticationprovider.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_ejbca"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-ejbca.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_identityprovider"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-identityprovider.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_keycloak"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-keycloak.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_onboarding"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-onboarding.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_securityattributesprovider"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-securityattributesprovider.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_usersroles"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-usersroles.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
      {{- end }}
      {{- range .Values.agentList.providers }}
      - name: 6-provider-secrets
        image: "quay.io/openbao/openbao:2.4.0"
        command: [sh, -c]
        args:
          - |
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-contract \
              API_KEY="apikey" \
              DB_URL="jdbc:postgresql://pg-cluster.{{ $.Values.cluster.namespace }}.svc.cluster.local:5432/{{ . }}_contract" \
              DB_USER="{{ . }}_contract" \
              DBPASSWORD="${{ . }}_contractdb" \
              KAFKA_CLIENT_PASSWORDS="${{ . }}_contract" \
              KAFKA_CLIENT_USER="{{ . }}_contract"
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-postgres-passwords \
              {{ . }}-authenticationprovider=${{ . }}_authenticationproviderdb \
              {{ . }}-keycloak=${{ . }}_keycloakdb \
              {{ . }}-usersroles=${{ . }}_usersrolesdb \
              {{ . }}-infrabe=${{ . }}_infrabedb \
              {{ . }}-edc=${{ . }}_edcdb
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-redis \
              rediscommander=$commander \
              redis=$redis
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-infra-adapter-simpl-backend \
              ENGINE_PATH="/opt/plugins/hashicorp-vault-provider.so" \
              HTTP_HOST="" \
              HTTP_IDLE_TIMEOUT="120s" \
              HTTP_PORT="8080" \
              HTTP_READ_TIMEOUT="10s" \
              HTTP_WRITE_TIMEOUT="10s" \
              LOG_ENCODING="json" \
              LOG_LEVEL="debug" \
              VAULT_ADRESS="https://secrets.{{ $.Values.namespaceTag }}.{{ $.Values.domainSuffix }}" \
              VAULT_TOKEN="$VAULT_TOKEN"
            if ! bao kv get -mount={{ $.Values.secrets.secretEngine }} {{ . }}-infrastructure-be > /dev/null 2>&1; then
              bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-infrastructure-be \
                gitea.token="giteatoken" \
                infrastructure.api.config.value="Bearer tok_uuid" \
                kafka.sasl.enabled=true \
                kafka.sasl.password="${{ . }}_infrabe" \
                kafka.sasl.username="{{ . }}_infrabe" \
                spring.datasource.password="${{ . }}_infrabedb" \
                spring.datasource.username="{{ . }}_infrabe" \
                spring.mail.password="smtppassword" \
                spring.mail.username="no-reply@simplservices.com" \
                vault.token="$VAULT_TOKEN"
            fi
            if ! bao kv get -mount={{ $.Values.secrets.secretEngine }} {{ . }}-simpl-edc > /dev/null 2>&1; then
              bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-simpl-edc \
                contractmanager_apikey="apikey" \
                edc_datasource_default_password="${{ . }}_edcdb" \
                edc_datasource_policy_password="${{ . }}_edcdb" \
                edc_ionos_access_key="accesskeystring" \
                edc_ionos_endpoint="s3-eu-central-1.ionoscloud.com" \
                edc_ionos_endpoint_region="de" \
                edc_ionos_secret_key="secretkeystring" \
                edc_ionos_token="tokenstring" \
                otel_experimental_log_level="debug" \
                otel_exporter_otlp_endpoint="http://collector.{{ $.Values.namespaceTag }}.{{ $.Values.domainSuffix }}" \
                otel_exporter_otlp_protocol="http/protobuf" \
                otel_instrumentation_http_url_connection_enabled="false" \
                otel_instrumentation_jdbc_enabled="false" \
                otel_instrumentation_jersey_enabled="false" \
                otel_instrumentation_servlet_enabled="false" \
                otel_logs_exporter="none" \
                otel_metrics_exporter="none" \
                otel_resource_attributes="service.name=edc,deployment.environment={{ . }}" \
                otel_traces_exporter="otlp"
            fi
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-keycloak admin=${{ . }}_kcadmin
        envFrom:
          - secretRef:
              name: kafka-users-secret
          - secretRef:
              name: redis-secrets
        env:
          - name: VAULT_TOKEN
            valueFrom:
              secretKeyRef:
                name: secrets-root-token
                key: token
          - name: VAULT_ADDR
            value: https://secrets.{{ $.Values.namespaceTag }}.{{ $.Values.domainSuffix }}
          - name: "{{ . }}_kcadmin"
            valueFrom:
              secretKeyRef:
                name: "keycloak-secrets"
                key: {{ . }}
          - name: "{{ . }}_gitea"
            valueFrom:
              secretKeyRef:
                name: "gitea-secrets"
                key: "gitops_test"
          - name: "{{ . }}_contractdb"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-contract.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_edcdb"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-edc.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_infrabedb"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-infrabe.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_authenticationproviderdb"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-authenticationprovider.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_keycloakdb"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-keycloak.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_usersrolesdb"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-usersroles.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
      {{- end }}
      {{- range .Values.agentList.consumers }}
      - name: 6-consumer-secrets
        image: "quay.io/openbao/openbao:2.4.0"
        command: [sh, -c]
        args:
          - |
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-contract \
              API_KEY="apikey" \
              DB_URL="jdbc:postgresql://pg-cluster.{{ $.Values.cluster.namespace }}.svc.cluster.local:5432/{{ . }}_contract" \
              DB_USER="{{ . }}_contract" \
              DBPASSWORD="${{ . }}_contractdb" \
              KAFKA_CLIENT_PASSWORDS="${{ . }}_contract" \
              KAFKA_CLIENT_USER="{{ . }}_contract"
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-contract-consumption-be \
              KAFKA_AUTH_SASL_PASSWORD="${{ . }}_contract_consumption" \
              KAFKA_AUTH_SASL_USERNAME="{{ . }}_contract_consumption"
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-redis \
              rediscommander=$commander \
              redis=$redis
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-edc-connector-adapter \
              KAFKA_AUTH_SASL_PASSWORD="${{ . }}_edcconn" \
              KAFKA_AUTH_SASL_USERNAME="{{ . }}_edcconn"
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-postgres-passwords \
              {{ . }}-authenticationprovider=${{ . }}_authenticationproviderdb \
              {{ . }}-keycloak=${{ . }}_keycloakdb \
              {{ . }}-usersroles=${{ . }}_usersrolesdb \
              {{ . }}-edc=${{ . }}_edcdb
            bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-keycloak admin=${{ . }}_kcadmin
            if ! bao kv get -mount={{ $.Values.secrets.secretEngine }} {{ . }}-simpl-edc > /dev/null 2>&1; then
              bao kv put -mount={{ $.Values.secrets.secretEngine }} {{ . }}-simpl-edc \
                contractmanager_apikey="apikey" \
                edc_datasource_default_password="${{ . }}_edcdb" \
                edc_datasource_policy_password="${{ . }}_edcdb" \
                edc_ionos_access_key="accesskeystring" \
                edc_ionos_endpoint="s3-eu-central-1.ionoscloud.com" \
                edc_ionos_endpoint_region="de" \
                edc_ionos_secret_key="secretkeystring" \
                edc_ionos_token="tokenstring" \
                otel_experimental_log_level="debug" \
                otel_exporter_otlp_endpoint="http://collector.{{ $.Values.namespaceTag }}.{{ $.Values.domainSuffix }}" \
                otel_exporter_otlp_protocol="http/protobuf" \
                otel_instrumentation_http_url_connection_enabled="false" \
                otel_instrumentation_jdbc_enabled="false" \
                otel_instrumentation_jersey_enabled="false" \
                otel_instrumentation_servlet_enabled="false" \
                otel_logs_exporter="none" \
                otel_metrics_exporter="none" \
                otel_resource_attributes="service.name=edc,deployment.environment={{ . }}" \
                otel_traces_exporter="otlp"
            fi
        envFrom:
          - secretRef:
              name: kafka-users-secret
          - secretRef:
              name: redis-secrets
        env:
          - name: VAULT_TOKEN
            valueFrom:
              secretKeyRef:
                name: secrets-root-token
                key: token
          - name: VAULT_ADDR
            value: https://secrets.{{ $.Values.namespaceTag }}.{{ $.Values.domainSuffix }}
          - name: "{{ . }}_kcadmin"
            valueFrom:
              secretKeyRef:
                name: "keycloak-secrets"
                key: {{ . }}
          - name: "{{ . }}_contractdb"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-contract.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_edcdb"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-edc.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_authenticationproviderdb"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-authenticationprovider.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_keycloakdb"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-keycloak.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
          - name: "{{ . }}_usersrolesdb"
            valueFrom:
              secretKeyRef:
                name: "{{ . }}-usersroles.pg-cluster.credentials.postgresql.acid.zalan.do"
                key: password
      {{- end }}
      containers:
      - name: final-step
        image: busybox
        command: ['sh', '-c', 'echo "Final step: End the process"']
        volumeMounts:
        - name: init-bao-volume
          mountPath: /data
      restartPolicy: Never
      volumes:
      - name: init-bao-volume
        persistentVolumeClaim:
          claimName: init-bao-{{ .Values.cluster.namespace }}-pvc